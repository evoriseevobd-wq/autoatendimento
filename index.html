<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Card√°pio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;0,700;0,800;1,600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f8f7f4;
      --bg2: #ffffff;
      --surface: #ffffff;
      --border: #e8e5e0;
      --border-dark: #d0ccc5;
      --text: #111110;
      --text2: #444340;
      --muted: #999590;
      --accent: #111110;
      --accent-text: #ffffff;
      --price: #111110;
      --radius: 16px;
      --radius-sm: 10px;
      --shadow: 0 2px 12px rgba(0,0,0,0.07);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 120px;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .header {
      background: #fff;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-inner {
      max-width: 720px;
      margin: 0 auto;
      padding: 18px 20px 14px;
    }

    .restaurant-name {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.01em;
      color: var(--text);
      line-height: 1.1;
    }

    .mesa-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .mesa-badge span {
      color: var(--text);
      font-weight: 700;
    }

    /* ‚îÄ‚îÄ CATEGORY NAV ‚îÄ‚îÄ */
    .cat-nav-wrap {
      background: #fff;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 82px;
      z-index: 90;
    }

    .cat-nav {
      max-width: 720px;
      margin: 0 auto;
      display: flex;
      gap: 6px;
      padding: 10px 20px;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .cat-nav::-webkit-scrollbar { display: none; }

    .cat-btn {
      flex-shrink: 0;
      padding: 6px 16px;
      border-radius: 999px;
      border: 1.5px solid var(--border-dark);
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      transition: all 0.18s ease;
      white-space: nowrap;
    }

    .cat-btn:hover {
      color: var(--text);
      border-color: var(--text);
    }

    .cat-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--accent-text);
    }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main {
      max-width: 720px;
      margin: 0 auto;
      padding: 28px 20px 40px;
    }

    /* ‚îÄ‚îÄ LOADING / ERROR ‚îÄ‚îÄ */
    .state-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 40vh;
      gap: 14px;
      text-align: center;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 2px solid var(--border);
      border-top-color: var(--text);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .state-box p {
      font-size: 14px;
      color: var(--muted);
      font-weight: 500;
    }

    .state-box .icon {
      font-size: 40px;
    }

    /* ‚îÄ‚îÄ CATEGORY SECTION ‚îÄ‚îÄ */
    .category-section {
      margin-bottom: 36px;
      animation: fadeUp 0.4s ease both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .category-title {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1.5px solid var(--border);
      letter-spacing: -0.01em;
    }

    .items-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ‚îÄ‚îÄ ITEM CARD ‚îÄ‚îÄ */
    .item-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      cursor: pointer;
      transition: all 0.18s ease;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .item-card:hover {
      border-color: var(--border-dark);
      box-shadow: var(--shadow-lg);
      transform: translateY(-1px);
    }

    .item-card.inactive {
      opacity: 0.45;
      pointer-events: none;
    }

    .item-img {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      object-fit: cover;
      flex-shrink: 0;
      background: var(--bg);
    }

    .item-img-placeholder {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: var(--border-dark);
    }

    .item-info {
      flex: 1;
      min-width: 0;
    }

    .item-name {
      font-weight: 700;
      font-size: 15px;
      color: var(--text);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-desc {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .item-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
    }

    .item-price {
      font-size: 16px;
      font-weight: 800;
      color: var(--price);
      font-family: 'Playfair Display', serif;
    }

    .item-inactive-tag {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.05em;
    }

    /* ‚îÄ‚îÄ ADD BUTTON ‚îÄ‚îÄ */
    .add-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: none;
      background: var(--accent);
      color: var(--accent-text);
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.18s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .add-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    }

    /* ‚îÄ‚îÄ ITEM COUNTER (when already in cart) ‚îÄ‚îÄ */
    .item-counter {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .counter-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1.5px solid var(--border-dark);
      background: transparent;
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      font-family: 'DM Sans', sans-serif;
      font-weight: 700;
    }

    .counter-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--accent-text);
    }

    .counter-qty {
      font-size: 15px;
      font-weight: 800;
      min-width: 20px;
      text-align: center;
    }

    /* ‚îÄ‚îÄ FLOATING CART BUTTON ‚îÄ‚îÄ */
    .cart-fab {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 200;
      background: var(--accent);
      color: var(--accent-text);
      border: none;
      border-radius: 999px;
      padding: 16px 28px;
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.22);
      transition: all 0.2s ease;
      white-space: nowrap;
      min-width: 260px;
      justify-content: space-between;
    }

    .cart-fab:hover {
      transform: translateX(-50%) translateY(-2px);
      box-shadow: 0 12px 36px rgba(0,0,0,0.28);
    }

    .cart-fab.hidden {
      display: none;
    }

    .cart-fab-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .cart-count-badge {
      background: rgba(255,255,255,0.25);
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 13px;
      font-weight: 800;
    }

    .cart-fab-price {
      font-size: 15px;
      font-weight: 800;
    }

    /* ‚îÄ‚îÄ CART DRAWER ‚îÄ‚îÄ */
    .cart-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 300;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .cart-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }

    .cart-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 400;
      background: #fff;
      border-radius: 24px 24px 0 0;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 -8px 40px rgba(0,0,0,0.15);
    }

    .cart-drawer.open {
      transform: translateY(0);
    }

    .cart-handle {
      width: 40px;
      height: 4px;
      background: var(--border-dark);
      border-radius: 999px;
      margin: 12px auto 0;
      flex-shrink: 0;
    }

    .cart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px 12px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .cart-title {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-weight: 700;
    }

    .cart-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1.5px solid var(--border-dark);
      background: transparent;
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .cart-close:hover {
      background: var(--bg);
    }

    .cart-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }

    .cart-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 48px 0;
      color: var(--muted);
    }

    .cart-empty .icon { font-size: 40px; }
    .cart-empty p { font-size: 14px; font-weight: 500; }

    .cart-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .cart-item:last-child { border-bottom: none; }

    .cart-item-name {
      flex: 1;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }

    .cart-item-qty {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cart-qty-btn {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 1.5px solid var(--border-dark);
      background: transparent;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .cart-qty-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--accent-text);
    }

    .cart-qty-num {
      font-size: 14px;
      font-weight: 800;
      min-width: 18px;
      text-align: center;
    }

    .cart-item-price {
      font-size: 14px;
      font-weight: 800;
      color: var(--text);
      min-width: 70px;
      text-align: right;
      font-family: 'Playfair Display', serif;
    }

    /* ‚îÄ‚îÄ CART FOOTER ‚îÄ‚îÄ */
    .cart-footer {
      padding: 16px 20px 28px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
      background: #fff;
    }

    .cart-total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .cart-total-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
    }

    .cart-total-value {
      font-size: 22px;
      font-weight: 800;
      font-family: 'Playfair Display', serif;
      color: var(--text);
    }

    .checkout-btn {
      width: 100%;
      padding: 16px;
      border-radius: var(--radius);
      border: none;
      background: var(--accent);
      color: var(--accent-text);
      font-family: 'DM Sans', sans-serif;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.18s ease;
      letter-spacing: 0.01em;
    }

    .checkout-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* ‚îÄ‚îÄ CHECKOUT MODAL ‚îÄ‚îÄ */
    .checkout-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .checkout-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }

    .checkout-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 600;
      background: #fff;
      border-radius: 24px 24px 0 0;
      padding: 20px 20px 40px;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 -8px 40px rgba(0,0,0,0.15);
      max-height: 90vh;
      overflow-y: auto;
    }

    .checkout-modal.open {
      transform: translateY(0);
    }

    .checkout-handle {
      width: 40px;
      height: 4px;
      background: var(--border-dark);
      border-radius: 999px;
      margin: 0 auto 20px;
    }

    .checkout-title {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
    }

    .form-field {
      margin-bottom: 14px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 13px 16px;
      border-radius: var(--radius-sm);
      border: 1.5px solid var(--border-dark);
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      font-weight: 500;
      outline: none;
      transition: border-color 0.18s ease;
    }

    .form-input:focus, .form-select:focus {
      border-color: var(--accent);
    }

    /* ‚îÄ‚îÄ MESA WARNING ‚îÄ‚îÄ */
    .mesa-warning {
      background: #111110;
      color: #fff;
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      line-height: 1.4;
    }

    .mesa-warning .warn-icon {
      font-size: 22px;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ ORDER SUMMARY ‚îÄ‚îÄ */
    .order-summary {
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      margin-bottom: 16px;
    }

    .order-summary-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 10px;
    }

    .order-summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text2);
      padding: 4px 0;
    }

    .order-summary-item span:last-child {
      font-weight: 700;
    }

    .order-summary-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border-dark);
      font-size: 16px;
      font-weight: 800;
      color: var(--text);
    }

    .confirm-btn {
      width: 100%;
      padding: 16px;
      border-radius: var(--radius);
      border: none;
      background: var(--accent);
      color: var(--accent-text);
      font-family: 'DM Sans', sans-serif;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.18s ease;
      margin-top: 8px;
    }

    .confirm-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .confirm-btn:hover:not(:disabled) {
      opacity: 0.9;
    }

    /* ‚îÄ‚îÄ SUCCESS SCREEN ‚îÄ‚îÄ */
    .success-screen {
      position: fixed;
      inset: 0;
      background: #fff;
      z-index: 700;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 32px;
      text-align: center;
      transform: scale(0.9);
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .success-screen.open {
      transform: scale(1);
      opacity: 1;
      pointer-events: auto;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #111110;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      animation: popIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.1s both;
    }

    @keyframes popIn {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }

    .success-title {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      font-weight: 800;
      color: var(--text);
    }

    .success-msg {
      font-size: 15px;
      color: var(--muted);
      line-height: 1.6;
      max-width: 300px;
    }

    .success-order {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      background: var(--bg);
      border: 1px solid var(--border-dark);
      border-radius: var(--radius-sm);
      padding: 10px 20px;
      letter-spacing: 0.04em;
    }

    .success-back-btn {
      margin-top: 8px;
      padding: 14px 32px;
      border-radius: 999px;
      border: 1.5px solid var(--border-dark);
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.18s ease;
    }

    .success-back-btn:hover {
      color: var(--text);
      border-color: var(--text);
    }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media (max-width: 480px) {
      .restaurant-name { font-size: 22px; }
      .item-img, .item-img-placeholder { width: 68px; height: 68px; }
      .cart-fab { min-width: 220px; padding: 14px 20px; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <div class="header-inner">
      <div class="restaurant-name" id="restaurant-name">Carregando...</div>
      <div class="mesa-badge" id="mesa-badge" style="display:none;">
        üìç Mesa <span id="mesa-num">‚Äî</span>
      </div>
    </div>
  </header>

  <!-- CATEGORY NAV -->
  <div class="cat-nav-wrap" id="cat-nav-wrap" style="display:none;">
    <div class="cat-nav" id="cat-nav"></div>
  </div>

  <!-- MAIN -->
  <main class="main" id="main">
    <div class="state-box" id="loading-state">
      <div class="spinner"></div>
      <p>Carregando card√°pio...</p>
    </div>
    <div class="state-box" id="error-state" style="display:none;">
      <div class="icon">üòï</div>
      <p id="error-msg">Erro ao carregar card√°pio.</p>
    </div>
    <div id="cardapio-content" style="display:none;"></div>
  </main>

  <!-- CART FAB -->
  <button class="cart-fab hidden" id="cart-fab" onclick="openCart()">
    <div class="cart-fab-left">
      <span>üõí</span>
      <span class="cart-count-badge" id="cart-count">0</span>
      <span>Ver carrinho</span>
    </div>
    <span class="cart-fab-price" id="cart-fab-price">R$ 0,00</span>
  </button>

  <!-- CART BACKDROP -->
  <div class="cart-backdrop" id="cart-backdrop" onclick="closeCart()"></div>

  <!-- CART DRAWER -->
  <div class="cart-drawer" id="cart-drawer">
    <div class="cart-handle"></div>
    <div class="cart-header">
      <div class="cart-title">Seu pedido</div>
      <button class="cart-close" onclick="closeCart()">√ó</button>
    </div>
    <div class="cart-body" id="cart-body"></div>
    <div class="cart-footer">
      <div class="cart-total-row">
        <span class="cart-total-label">Total</span>
        <span class="cart-total-value" id="cart-total">R$ 0,00</span>
      </div>
      <button class="checkout-btn" onclick="openCheckout()">Finalizar pedido ‚Üí</button>
    </div>
  </div>

  <!-- CHECKOUT BACKDROP -->
  <div class="checkout-backdrop" id="checkout-backdrop" onclick="closeCheckout()"></div>

  <!-- CHECKOUT MODAL -->
  <div class="checkout-modal" id="checkout-modal">
    <div class="checkout-handle"></div>
    <div class="checkout-title">Confirmar pedido</div>

    <div class="mesa-warning" id="mesa-warning">
      <span class="warn-icon">‚ö†Ô∏è</span>
      <span id="mesa-warning-text">Seu pedido ser√° feito na Mesa ‚Äî. N√£o mude de mesa!</span>
    </div>

    <div class="form-field">
      <label class="form-label">Seu nome</label>
      <input class="form-input" id="input-name" placeholder="Ex: Jo√£o Silva" />
    </div>

    <div class="form-field">
      <label class="form-label">Forma de pagamento</label>
      <select class="form-select" id="input-payment">
        <option value="">Selecione...</option>
        <option value="pix">PIX</option>
        <option value="credito">Cart√£o de cr√©dito</option>
        <option value="debito">Cart√£o de d√©bito</option>
        <option value="dinheiro">Dinheiro</option>
      </select>
    </div>

    <div class="order-summary" id="checkout-summary"></div>

    <button class="confirm-btn" id="confirm-btn" onclick="submitOrder()">
      Fazer pedido
    </button>
  </div>

  <!-- SUCCESS SCREEN -->
  <div class="success-screen" id="success-screen">
    <div class="success-icon">‚úì</div>
    <div class="success-title">Pedido feito!</div>
    <p class="success-msg">Seu pedido foi enviado para a cozinha. Aguarde, logo estar√° pronto!</p>
    <div class="success-order" id="success-order-num"></div>
    <button class="success-back-btn" onclick="resetAll()">Fazer novo pedido</button>
  </div>

  <script>
    // ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
    const API_BASE = 'https://kds-backend.dahead.easypanel.host';

    // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
    let restaurantId = null;
    let mesaNum = null;
    let cardapioItems = [];
    let cart = {}; // { itemId: { item, qty } }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
    async function init() {
      const params = new URLSearchParams(window.location.search);
      mesaNum = params.get('mesa') || null;

      if (mesaNum) {
        document.getElementById('mesa-badge').style.display = 'flex';
        document.getElementById('mesa-num').textContent = mesaNum;
      }

      // Resolve restaurant_id pelo dom√≠nio
      try {
        const dominio = window.location.hostname;
        const resp = await fetch(`${API_BASE}/api/v1/dominio/${dominio}`);
        if (!resp.ok) throw new Error('Dom√≠nio n√£o cadastrado');
        const data = await resp.json();
        restaurantId = data.restaurant_id;

        await loadRestaurant();
        await loadCardapio();
      } catch (e) {
        showError('Card√°pio n√£o encontrado. Verifique o link.');
      }
    }

    async function loadRestaurant() {
      try {
        // Busca o nome do restaurante
        const resp = await fetch(`${API_BASE}/api/v1/restaurante/${restaurantId}`);
        if (!resp.ok) return;
        const data = await resp.json();
        document.title = data.name || 'Card√°pio';
        document.getElementById('restaurant-name').textContent = data.name || 'Card√°pio';
      } catch(e) {
        document.getElementById('restaurant-name').textContent = 'Card√°pio';
      }
    }

    async function loadCardapio() {
      try {
        const resp = await fetch(`${API_BASE}/api/v1/cardapio/${restaurantId}`);
        if (!resp.ok) throw new Error('Erro ao buscar card√°pio');
        const data = await resp.json();

        cardapioItems = Array.isArray(data) ? data : [];

        if (cardapioItems.length === 0) {
          showError('Nenhum item no card√°pio ainda.');
          return;
        }

        renderCardapio();
      } catch(e) {
        showError('Erro ao carregar card√°pio. Tente novamente.');
      }
    }

    function renderCardapio() {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('cardapio-content').style.display = 'block';
      document.getElementById('cat-nav-wrap').style.display = 'block';

      // Agrupa por categoria respeitando a ordem
      const categorias = {};
      cardapioItems
        .sort((a, b) => (a.ordem || 0) - (b.ordem || 0))
        .forEach(item => {
          const cat = item.categoria || 'Geral';
          if (!categorias[cat]) categorias[cat] = [];
          categorias[cat].push(item);
        });

      // Renderiza nav de categorias
      const catNav = document.getElementById('cat-nav');
      catNav.innerHTML = '';
      Object.keys(categorias).forEach((cat, i) => {
        const btn = document.createElement('button');
        btn.className = 'cat-btn' + (i === 0 ? ' active' : '');
        btn.textContent = cat;
        btn.onclick = () => {
          document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`cat-${slugify(cat)}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
        };
        catNav.appendChild(btn);
      });

      // Renderiza itens
      const content = document.getElementById('cardapio-content');
      content.innerHTML = '';

      Object.entries(categorias).forEach(([cat, items], idx) => {
        const section = document.createElement('div');
        section.className = 'category-section';
        section.id = `cat-${slugify(cat)}`;
        section.style.animationDelay = `${idx * 0.08}s`;

        section.innerHTML = `<div class="category-title">${cat}</div>`;

        const grid = document.createElement('div');
        grid.className = 'items-grid';

        items.forEach(item => {
          grid.appendChild(buildItemCard(item));
        });

        section.appendChild(grid);
        content.appendChild(section);
      });
    }

    function buildItemCard(item) {
      const card = document.createElement('div');
      card.className = 'item-card' + (!item.ativo ? ' inactive' : '');
      card.id = `item-card-${item.id}`;

      const inCart = cart[item.id];

      card.innerHTML = `
        ${item.foto_url
          ? `<img class="item-img" src="${item.foto_url}" alt="${escHtml(item.nome)}" loading="lazy" />`
          : `<div class="item-img-placeholder">üçΩÔ∏è</div>`
        }
        <div class="item-info">
          <div class="item-name">${escHtml(item.nome)}</div>
          ${item.descricao ? `<div class="item-desc">${escHtml(item.descricao)}</div>` : ''}
          <div class="item-footer">
            <div class="item-price">${formatCurrency(item.preco)}</div>
            ${!item.ativo
              ? `<span class="item-inactive-tag">Indispon√≠vel</span>`
              : inCart
                ? `<div class="item-counter">
                    <button class="counter-btn" onclick="changeQty('${item.id}', -1, event)">‚àí</button>
                    <span class="counter-qty">${inCart.qty}</span>
                    <button class="counter-btn" onclick="changeQty('${item.id}', 1, event)">+</button>
                  </div>`
                : `<button class="add-btn" onclick="addToCart('${item.id}', event)">+</button>`
            }
          </div>
        </div>
      `;

      return card;
    }

    function refreshItemCard(itemId) {
      const item = cardapioItems.find(i => i.id === itemId);
      if (!item) return;
      const old = document.getElementById(`item-card-${itemId}`);
      if (!old) return;
      const newCard = buildItemCard(item);
      old.replaceWith(newCard);
    }

    // ‚îÄ‚îÄ CART LOGIC ‚îÄ‚îÄ
    function addToCart(itemId, e) {
      if (e) e.stopPropagation();
      const item = cardapioItems.find(i => i.id === itemId);
      if (!item) return;
      cart[itemId] = { item, qty: 1 };
      refreshItemCard(itemId);
      updateCartUI();
    }

    function changeQty(itemId, delta, e) {
      if (e) e.stopPropagation();
      if (!cart[itemId]) return;
      cart[itemId].qty += delta;
      if (cart[itemId].qty <= 0) {
        delete cart[itemId];
      }
      refreshItemCard(itemId);
      updateCartUI();
    }

    function updateCartUI() {
      const items = Object.values(cart);
      const totalQty = items.reduce((s, c) => s + c.qty, 0);
      const totalPrice = items.reduce((s, c) => s + c.qty * parseFloat(c.item.preco || 0), 0);

      const fab = document.getElementById('cart-fab');
      if (totalQty === 0) {
        fab.classList.add('hidden');
      } else {
        fab.classList.remove('hidden');
        document.getElementById('cart-count').textContent = totalQty;
        document.getElementById('cart-fab-price').textContent = formatCurrency(totalPrice);
      }

      // Update cart drawer
      renderCartBody();
      document.getElementById('cart-total').textContent = formatCurrency(totalPrice);
    }

    function renderCartBody() {
      const body = document.getElementById('cart-body');
      const items = Object.values(cart);

      if (items.length === 0) {
        body.innerHTML = `
          <div class="cart-empty">
            <div class="icon">üõí</div>
            <p>Seu carrinho est√° vazio</p>
          </div>
        `;
        return;
      }

      body.innerHTML = items.map(({ item, qty }) => `
        <div class="cart-item">
          <div class="cart-item-name">${escHtml(item.nome)}</div>
          <div class="cart-item-qty">
            <button class="cart-qty-btn" onclick="changeQty('${item.id}', -1)">‚àí</button>
            <span class="cart-qty-num">${qty}</span>
            <button class="cart-qty-btn" onclick="changeQty('${item.id}', 1)">+</button>
          </div>
          <div class="cart-item-price">${formatCurrency(qty * parseFloat(item.preco || 0))}</div>
        </div>
      `).join('');
    }

    // ‚îÄ‚îÄ CART DRAWER ‚îÄ‚îÄ
    function openCart() {
      document.getElementById('cart-backdrop').classList.add('open');
      document.getElementById('cart-drawer').classList.add('open');
      renderCartBody();
    }

    function closeCart() {
      document.getElementById('cart-backdrop').classList.remove('open');
      document.getElementById('cart-drawer').classList.remove('open');
    }

    // ‚îÄ‚îÄ CHECKOUT ‚îÄ‚îÄ
    function openCheckout() {
      closeCart();

      // Mesa warning
      const warningText = mesaNum
        ? `Seu pedido ser√° feito na Mesa ${mesaNum}. N√£o mude de mesa!`
        : `Confirme seu pedido abaixo.`;
      document.getElementById('mesa-warning-text').textContent = warningText;
      document.getElementById('mesa-warning').style.display = mesaNum ? 'flex' : 'none';

      // Summary
      const items = Object.values(cart);
      const total = items.reduce((s, c) => s + c.qty * parseFloat(c.item.preco || 0), 0);

      const summaryEl = document.getElementById('checkout-summary');
      summaryEl.innerHTML = `
        <div class="order-summary-title">Resumo do pedido</div>
        ${items.map(({ item, qty }) => `
          <div class="order-summary-item">
            <span>${qty}x ${escHtml(item.nome)}</span>
            <span>${formatCurrency(qty * parseFloat(item.preco || 0))}</span>
          </div>
        `).join('')}
        <div class="order-summary-total">
          <span>Total</span>
          <span>${formatCurrency(total)}</span>
        </div>
      `;

      document.getElementById('checkout-backdrop').classList.add('open');
      document.getElementById('checkout-modal').classList.add('open');
    }

    function closeCheckout() {
      document.getElementById('checkout-backdrop').classList.remove('open');
      document.getElementById('checkout-modal').classList.remove('open');
    }

    async function submitOrder() {
      const name = document.getElementById('input-name').value.trim();
      const payment = document.getElementById('input-payment').value;

      if (!name) {
        alert('Por favor, informe seu nome.');
        document.getElementById('input-name').focus();
        return;
      }
      if (!payment) {
        alert('Por favor, selecione a forma de pagamento.');
        return;
      }

      const items = Object.values(cart);
      const total = items.reduce((s, c) => s + c.qty * parseFloat(c.item.preco || 0), 0);

      const itens = items.map(({ item, qty }) => ({
        name: item.nome,
        qty,
        quantidade: qty,
        price: parseFloat(item.preco || 0),
        preco: parseFloat(item.preco || 0)
      }));

      const btn = document.getElementById('confirm-btn');
      btn.disabled = true;
      btn.textContent = 'Enviando...';

      try {
        const body = {
          restaurant_id: restaurantId,
          client_name: name,
          itens,
          total_price: total,
          service_type: 'local',
          payment_method: payment,
          origin: 'balcao',
          notes: mesaNum ? `Mesa ${mesaNum}` : ''
        };

        const resp = await fetch(`${API_BASE}/api/v1/pedidos`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Erro ao criar pedido');

        closeCheckout();
        showSuccess(data.order?.order_number);
      } catch(e) {
        alert('Erro ao enviar pedido. Tente novamente.\n' + e.message);
        btn.disabled = false;
        btn.textContent = 'Fazer pedido';
      }
    }

    function showSuccess(orderNum) {
      document.getElementById('success-order-num').textContent = orderNum ? `Pedido #${orderNum}` : 'Pedido confirmado';
      document.getElementById('success-screen').classList.add('open');
    }

    function resetAll() {
      cart = {};
      document.getElementById('success-screen').classList.remove('open');
      document.getElementById('input-name').value = '';
      document.getElementById('input-payment').value = '';
      updateCartUI();
      renderCardapio();
    }

    // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
    function showError(msg) {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('error-state').style.display = 'flex';
      document.getElementById('error-msg').textContent = msg;
    }

    function formatCurrency(v) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
    }

    function escHtml(str) {
      return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function slugify(str) {
      return String(str || '').toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');
    }

    // ‚îÄ‚îÄ START ‚îÄ‚îÄ
    init();
  </script>
</body>
</html>
